<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>EPRA EER SYSTEM</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjs/lib/browser/math.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>
<style>
  .small-input { max-width:120px; display:inline-block; }
  .summary-box { background:#fff; padding:12px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,0.03); }
  .table-wrap { overflow-x:auto; margin-top:1rem; }
  .category-title { margin-top: 1rem; font-weight:bold; }
  h2 { color: blue; font-weight:bold; }
  #tablesContainer table th, #tablesContainer table td { min-width: 80px; text-align:center; }
  #tablesContainer .form-control.data-input { min-width: 80px; padding: 2px 6px; text-align: right; }
  #tablesContainer .form-control.facility-name { min-width: 140px; }
  #tablesContainer table thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 2; }
</style>
</head>
<body class="p-2 bg-light">
<div class="container-fluid">
  <h2 class="mb-3 text-center">EPRA EER SYSTEM</h2>

  <ul class="nav nav-tabs" id="tabMenu">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#adminTab">ADMIN EPRA</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#facilityTab">FACILITY ACCESS</a></li>
  </ul>

  <div class="tab-content mt-3">
    <!-- ADMIN TAB -->
    <div class="tab-pane fade show active" id="adminTab">
      <div class="card p-3 mb-3">
        <h5>ADMIN CONTROLS</h5>
        <div class="row g-2 align-items-end">
          <div class="col-sm-2">
            <label class="form-label">No. of Facilities</label>
            <input type="number" id="facilityCount" value="3" min="1" class="form-control">
          </div>
          <div class="col-sm-10 d-flex gap-2 flex-wrap">
            <button class="btn btn-primary mt-2" onclick="generateTables()">GENERATE TABLES</button>
            <input type="file" id="excelUpload" class="form-control mt-2 w-auto" accept=".xlsx,.xls">
            <button class="btn btn-info mt-2" onclick="processExcel()">PROCESS EXCEL</button>
            <button class="btn btn-success mt-2" onclick="displaySummary()">GENERATE SUMMARY</button>
            <button id="regressBtn" class="btn btn-warning mt-2" style="display:none;" onclick="runOLSRegression()">RUN REGRESSION</button>
            <button class="btn btn-danger mt-2" onclick="resetAdmin()">RESET ADMIN</button>
          </div>
        </div>
      </div>

      <div class="table-wrap" id="tablesContainer"></div>

      <div class="table-wrap mt-3">
        <h5>MONTHLY SUMMARY</h5><div id="summaryOutput"></div>
      </div>

      <div class="table-wrap mt-3">
        <h5>REGRESSION OUTPUT</h5><div id="regressionOutput"></div>
      </div>

      <div class="table-wrap mt-3">
        <h5>EER SUMMARY</h5>
        <label>Cutoff EER:</label>
        <input type="number" id="cutoffEER" class="form-control small-input mb-2" step="0.01" value="0.9">
        <button class="btn btn-success mb-2" onclick="applyCutoff()">APPLY CUTOFF</button>
        <div id="eerSummary"></div>
      </div>

      <div class="table-wrap mt-3">
        <h5>POSSIBLE SAVINGS / CREDITS</h5>
        <div id="savingsTable"></div>
      </div>

      <div class="table-wrap mt-3">
        <h5>OGIVE CHART</h5>
        <canvas id="ogiveChart" height="200"></canvas>
      </div>
    </div>

    <!-- FACILITY TAB -->
    <div class="tab-pane fade" id="facilityTab">
      <div class="card p-3 mb-3">
        <h5>FACILITY INPUT</h5>
        <div class="row g-2 align-items-end">
          <div class="col-sm-3">
            <label class="form-label">Cutoff EER</label>
            <input type="number" id="facilityCutoff" class="form-control" step="0.01" value="0.9"/>
          </div>
          <div class="col-sm-3">
            <label class="form-label">Facility Name</label>
            <input type="text" id="facilityName" class="form-control"/>
          </div>
          <div class="col-sm-6 d-flex gap-2 flex-wrap">
            <button class="btn btn-primary mt-2" onclick="generateFacilityTable()">GENERATE 24-MONTH TABLE</button>
            <button class="btn btn-outline-secondary mt-2" onclick="resetFacility()">RESET</button>
          </div>
        </div>
        <div id="facilityInputs" class="mt-3 table-wrap"></div>
      </div>
      <div class="card p-3 mb-3">
        <h5>FACILITY RESULTS</h5>
        <div id="facilityResults" class="summary-box"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ----------------- Utilities ----------------- */
function parseCell(v){if(v===null||v===undefined)return null; if(typeof v==='number')return Number.isFinite(v)?v:null; const s=String(v).trim(); if(s==='')return null; const n=Number(s.replace(/,/g,'')); return Number.isFinite(n)?n:null;}
function sumNonNull(arr){return arr.reduce((s,x)=>s+(x===null?0:x),0);}
function avgNonNull(arr){const vals=arr.filter(x=>x!==null);return vals.length?(vals.reduce((a,b)=>a+b,0)/vals.length):null;}

const categories=[{name:'Energy',type:'sum'},{name:'Production',type:'sum'},{name:'Weather1',type:'avg'},{name:'Weather2',type:'avg'}];
let unifiedSummary=[], regressionCoeffs=null, ogiveChart=null;

/* ----------------- Generate Admin Tables ----------------- */
function generateTables(){
  const container=document.getElementById('tablesContainer'); container.innerHTML='';
  const facilityCount=Math.max(0, parseInt(document.getElementById('facilityCount').value)||0);
  categories.forEach(cat=>{
    const title=document.createElement('div'); title.className='category-title'; title.innerText=cat.name; container.appendChild(title);
    const table=document.createElement('table'); table.className='table table-bordered table-sm table-striped'; table.setAttribute('data-category',cat.name);
    const thead=document.createElement('thead'); let tr=document.createElement('tr'); tr.innerHTML='<th>Facility</th>';
    for(let m=1;m<=24;m++) tr.innerHTML+=`<th>${m}</th>`; thead.appendChild(tr); table.appendChild(thead);
    const tbody=document.createElement('tbody');
    for(let f=1;f<=facilityCount;f++){
      let row=document.createElement('tr'); row.innerHTML=`<td><input type="text" class="form-control facility-name"></td>`;
      for(let m=1;m<=24;m++) row.innerHTML+=`<td><input type="text" class="form-control data-input"></td>`;
      tbody.appendChild(row);
    }
    table.appendChild(tbody); container.appendChild(table);
  });
  document.getElementById('regressBtn').style.display='none';
}

/* ----------------- Process Excel ----------------- */
function processExcel(){
  const fileInput=document.getElementById('excelUpload');
  if(!fileInput.files.length) return alert('Select an Excel file first.');
  const file=fileInput.files[0]; const reader=new FileReader();
  reader.onload=(e)=>{
    try{
      const data=new Uint8Array(e.target.result); const wb=XLSX.read(data,{type:'array'});
      const sheet=wb.Sheets[wb.SheetNames[0]]; const grid=XLSX.utils.sheet_to_json(sheet,{header:1,blankrows:true});
      if(!grid||grid.length<2) return alert('Excel is empty or invalid.');
      let facilityCount=0;
      for(let r=1;r<grid.length;r++){ if(grid[r]&&grid[r][0]&&String(grid[r][0]).trim()!=='') facilityCount++; }
      if(facilityCount===0) return alert('No valid facility rows found in Excel.');
      document.getElementById('facilityCount').value=facilityCount; generateTables();
      const tables={}; document.querySelectorAll('#tablesContainer table').forEach(t=>tables[t.getAttribute('data-category')]=t);
      let rowIndex=0;
      for(let r=1;r<grid.length;r++){
        const row=grid[r]; if(!row||!row[0]||String(row[0]).trim()==='') continue;
        const fname=String(row[0]).trim();
        categories.forEach((cat,ci)=>{
          const tr=tables[cat.name].querySelectorAll('tbody tr')[rowIndex];
          if(!tr) return; const inputs=tr.querySelectorAll('td input'); inputs[0].value=fname;
          for(let m=0;m<24;m++){ const colIndex=1+ci*24+m; const val=parseCell(row[colIndex]); inputs[m+1].value=val===null?'':val; }
        });
        rowIndex++;
      }
      alert('Excel processed into category tables successfully.');
    }catch(err){ alert('Error reading Excel: '+err.message);}
  };
  reader.readAsArrayBuffer(file);
}

/* ----------------- Display Summary ----------------- */
function displaySummary(){
  unifiedSummary=[]; const tableMap={};
  document.querySelectorAll('#tablesContainer table').forEach(t=>tableMap[t.getAttribute('data-category')]=t);
  const facilityMap=new Map();
  categories.forEach(cat=>{
    const tbl=tableMap[cat.name]; if(!tbl) return;
    tbl.querySelectorAll('tbody tr').forEach(row=>{
      const inputs=row.querySelectorAll('td input'); if(!inputs||inputs.length===0) return;
      const fname=(inputs[0].value||'').trim(); if(!fname) return;
      if(!facilityMap.has(fname)) facilityMap.set(fname,{facility:fname,Energy:Array(24).fill(null),Production:Array(24).fill(null),Weather1:Array(24).fill(null),Weather2:Array(24).fill(null)});
      const obj=facilityMap.get(fname);
      for(let m=1;m<inputs.length&&m<=24;m++){ const val=parseCell(inputs[m].value); if(val!==null) obj[cat.name][m-1]=val;}
    });
  });
  unifiedSummary=Array.from(facilityMap.values());
  if(unifiedSummary.length===0){ document.getElementById('summaryOutput').innerHTML='<p>No facility data found in tables.</p>'; document.getElementById('regressBtn').style.display='none'; return;}
  renderSummary(unifiedSummary); document.getElementById('regressBtn').style.display='inline-block';
}

function renderSummary(list){
  let html='<table class="table table-bordered table-sm"><thead><tr><th>Facility</th><th>Total Energy</th><th>Total Production</th><th>Avg Weather1</th><th>Avg Weather2</th></tr></thead><tbody>';
  list.forEach(f=>{ html+=`<tr><td>${f.facility}</td><td>${sumNonNull(f.Energy).toFixed(2)}</td><td>${sumNonNull(f.Production).toFixed(2)}</td><td>${avgNonNull(f.Weather1)?.toFixed(2)||'-'}</td><td>${avgNonNull(f.Weather2)?.toFixed(2)||'-'}</td></tr>`; });
  html+='</tbody></table>'; document.getElementById('summaryOutput').innerHTML=html;
}

/* ----------------- OLS Regression ----------------- */
function runOLSRegression(){
  if(!unifiedSummary||unifiedSummary.length===0) return alert('Generate summary first.');
  const X=[], Y=[];
  unifiedSummary.forEach(f=>{
    for(let i=0;i<24;i++){
      const e=f.Energy[i], p=f.Production[i], w1=f.Weather1[i], w2=f.Weather2[i];
      if(e!==null && p!==null && w1!==null && w2!==null){ X.push([1,p,w1,w2]); Y.push(e); }
    }
  });
  if(Y.length<5) return alert('Not enough data for regression.');
  try{
    const Xt=math.transpose(X), XtX=math.multiply(Xt,X), XtXinv=math.inv(XtX), XtY=math.multiply(Xt,Y), beta=math.multiply(XtXinv,XtY);
    regressionCoeffs=beta;
    const Yhat=X.map(row=>math.dot(row,beta)), residuals=Y.map((y,i)=>y-Yhat[i]), N=Y.length, p=X[0].length;
    const residualVariance=residuals.reduce((s,r)=>s+r*r,0)/(N-p);
    const se=math.diag(XtXinv).map(v=>Math.sqrt(v*residualVariance));
    const tStats=beta.map((b,i)=>b/se[i]);
    const pValues=tStats.map(t=>2*(1-jStat.studentt.cdf(Math.abs(t),N-p)));
    const Ymean=Y.reduce((a,b)=>a+b,0)/N;
    const SSres=residuals.reduce((s,r)=>s+r*r,0);
    const SStot=Y.reduce((s,y)=>s+(y-Ymean)**2,0);
    const R2=1-SSres/SStot;
    const adjR2=1-(1-R2)*(N-1)/(N-p);
    let html='<table class="table table-sm table-bordered"><thead><tr><th>Coefficient</th><th>Estimate</th><th>Std. Error</th><th>t value</th><th>p value</th></tr></thead><tbody>';
    ['Intercept','Production','Weather1','Weather2'].forEach((name,i)=>{ html+=`<tr><td>${name}</td><td>${beta[i].toFixed(4)}</td><td>${se[i].toFixed(4)}</td><td>${tStats[i].toFixed(3)}</td><td>${pValues[i].toFixed(4)}</td></tr>`; });
    html+='</tbody></table>'; html+=`<p><strong>R²:</strong> ${R2.toFixed(4)} | <strong>Adj R²:</strong> ${adjR2.toFixed(4)} | <strong>Residual Std Error:</strong> ${Math.sqrt(residualVariance).toFixed(4)}</p>`;
    document.getElementById('regressionOutput').innerHTML=html; renderEERSummary();
  }catch(err){ alert('Regression failed: '+err.message);}
}

/* ----------------- EER Summary & Savings ----------------- */
function renderEERSummary(){
  if(!unifiedSummary||!regressionCoeffs) return;
  let html='<table class="table table-bordered table-sm"><thead><tr><th>Facility</th><th>Total Energy</th><th>Total Production</th><th>Actual EUI</th><th>Predicted EUI</th><th>EER</th><th>New EUI</th></tr></thead><tbody>';
  const eerList=[]; const cutoff=parseFloat(document.getElementById('cutoffEER').value)||0;
  unifiedSummary.forEach(f=>{
    const totalE=sumNonNull(f.Energy), totalP=sumNonNull(f.Production);
    const actualEUI=(totalP>0)?totalE/totalP:null;
    const predEnergy=f.Production.map(p=>math.dot([1,p,avgNonNull(f.Weather1)||0, avgNonNull(f.Weather2)||0], regressionCoeffs));
    const totalPred=sumNonNull(predEnergy);
    const predictedEUI=(totalP>0)?totalPred/totalP:null;
    const eer=(actualEUI!==null && predictedEUI!==null && predictedEUI!==0)?actualEUI/predictedEUI:null;
    const newEUI=(predictedEUI!==null)?cutoff*predictedEUI:null;
    eerList.push({facility:f.facility,eer});
    html+=`<tr><td>${f.facility}</td><td>${totalE.toFixed(2)}</td><td>${totalP.toFixed(2)}</td><td>${actualEUI===null?'-':actualEUI.toFixed(4)}</td><td>${predictedEUI===null?'-':predictedEUI.toFixed(4)}</td><td>${eer===null?'-':eer.toFixed(4)}</td><td>${newEUI===null?'-':newEUI.toFixed(4)}</td></tr>`;
  });
  html+='</tbody></table>'; document.getElementById('eerSummary').innerHTML=html; renderPossibleSavings(cutoff); renderOgive(eerList);
}

function renderPossibleSavings(cutoff){
  let html='<table class="table table-bordered table-sm"><thead><tr><th>Facility</th><th>Old EER</th><th>New EER</th><th>Production</th><th>Possible Savings / Credits</th></tr></thead><tbody>';
  unifiedSummary.forEach(f=>{
    const totalE=sumNonNull(f.Energy), totalP=sumNonNull(f.Production);
    const actualEUI=(totalP>0)?totalE/totalP:null;
    const predEnergy=f.Production.map(p=>math.dot([1,p,avgNonNull(f.Weather1)||0, avgNonNull(f.Weather2)||0], regressionCoeffs));
    const totalPred=sumNonNull(predEnergy);
    const predictedEUI=(totalP>0)?totalPred/totalP:null;
    const oldEER=(actualEUI!==null && predictedEUI!==null)?actualEUI/predictedEUI:null;
    const newEER=(predictedEUI!==null)?cutoff: null;
    const possibleSavings=(oldEER!==null && newEER!==null)?(oldEER-newEER)*totalP:null;
    html+=`<tr><td>${f.facility}</td><td>${oldEER===null?'-':oldEER.toFixed(4)}</td><td>${newEER===null?'-':newEER.toFixed(4)}</td><td>${totalP.toFixed(2)}</td><td>${possibleSavings===null?'-':possibleSavings.toFixed(2)}</td></tr>`;
  });
  html+='</tbody></table>'; document.getElementById('savingsTable').innerHTML=html;
}

function renderOgive(eerList){
  if(!eerList||eerList.length===0) return;
  const sorted=eerList.map(x=>x.eer).filter(x=>x!==null).sort((a,b)=>a-b);
  const cumPerc=sorted.map((v,i)=>((i+1)/sorted.length)*100);
  const ctx=document.getElementById('ogiveChart').getContext('2d');
  if(ogiveChart) ogiveChart.destroy();
  ogiveChart=new Chart(ctx,{
    type:'line',
    data:{ labels:sorted.map(v=>v.toFixed(4)), datasets:[{label:'Cumulative % Frequency', data:cumPerc, borderColor:'blue', backgroundColor:'rgba(0,0,255,0.1)', fill:true, tension:0.2, pointRadius:3 }] },
    options:{ responsive:true, plugins:{ legend:{display:true}}, scales:{ x:{title:{display:true,text:'EER'}}, y:{title:{display:true,text:'Cumulative % Frequency'}, min:0, max:100}}}
  });
}

function applyCutoff(){ renderEERSummary(); }
function resetAdmin(){ document.getElementById('tablesContainer').innerHTML=''; document.getElementById('summaryOutput').innerHTML=''; document.getElementById('regressionOutput').innerHTML=''; document.getElementById('eerSummary').innerHTML=''; document.getElementById('savingsTable').innerHTML=''; if(ogiveChart) ogiveChart.destroy(); regressionCoeffs=null; unifiedSummary=[]; document.getElementById('regressBtn').style.display='none'; }

/* ----------------- Facility Tab ----------------- */
function generateFacilityTable(){
  const name=document.getElementById('facilityName').value.trim(); if(!name) return alert('Enter facility name');
  const container=document.getElementById('facilityInputs'); container.innerHTML='';
  const table=document.createElement('table'); table.className='table table-bordered table-sm';
  table.innerHTML='<tr><th>Month</th><th>Energy</th><th>Production</th></tr>';
  for(let m=1;m<=24;m++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m}</td><td><input type="text" class="form-control data-input"></td><td><input type="text" class="form-control data-input"></td>`;
    table.appendChild(tr);
  }
  container.appendChild(table);
  const btn=document.createElement('button'); btn.className='btn btn-success mt-2'; btn.innerText='Compute Facility EER'; btn.onclick=()=>computeFacilityEER(name); container.appendChild(btn);
}

function computeFacilityEER(name){
  const table=document.querySelector('#facilityInputs table'); if(!table) return;
  const energyInputs=table.querySelectorAll('tr td:nth-child(2) input');
  const prodInputs=table.querySelectorAll('tr td:nth-child(3) input');
  let totalE=0, totalP=0; const energy=[], production=[];
  for(let i=0;i<24;i++){
    const e=parseCell(energyInputs[i].value), p=parseCell(prodInputs[i].value);
    energy.push(e!==null?e:0); production.push(p!==null?p:0);
    if(e!==null) totalE+=e; if(p!==null) totalP+=p;
  }
  const actualEUI=(totalP>0)?totalE/totalP:null; const cutoff=parseFloat(document.getElementById('facilityCutoff').value)||0;
  let actualEER=null, newEUI=null, possibleSavings=null;
  if(actualEUI!==null && regressionCoeffs){
    const avgWeather1=0, avgWeather2=0;
    const predEnergy=production.map(p=>math.dot([1,p,avgWeather1,avgWeather2],regressionCoeffs));
    const totalPred=sumNonNull(predEnergy); const predictedEUI=(totalP>0)?totalPred/totalP:null;
    actualEER=(predictedEUI!==0)?actualEUI/predictedEUI:null; newEUI=(predictedEUI!==null)?cutoff*predictedEUI:null;
    possibleSavings=(actualEER!==null && newEUI!==null)?(actualEUI-newEUI)*totalP:null;
  }
  document.getElementById('facilityResults').innerHTML=`
    <p><strong>${name}</strong></p>
    <ul>
      <li>Total Energy: ${totalE.toFixed(2)}</li>
      <li>Total Production: ${totalP.toFixed(2)}</li>
      <li>Actual EUI: ${actualEUI===null?'-':actualEUI.toFixed(4)}</li>
      <li>Actual EER: ${actualEER===null?'-':actualEER.toFixed(4)}</li>
      <li>Required New EER: ${cutoff.toFixed(2)}</li>
      <li>Required New EUI: ${newEUI===null?'-':newEUI.toFixed(4)}</li>
      <li>Possible Energy Savings (2 yrs): ${possibleSavings===null?'-':possibleSavings.toFixed(2)}</li>
    </ul>
  `;
}

function resetFacility(){ document.getElementById('facilityInputs').innerHTML=''; document.getElementById('facilityResults').innerHTML=''; document.getElementById('facilityName').value=''; }
</script>
</body>
</html>
